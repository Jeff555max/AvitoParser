# AvitoParser

Сложный веб-парсер, предназначенный для обхода защиты от ботов с использованием curl-cffi и Playwright.

## Возможности

- Обходит Cloudflare и другие системы защиты от ботов
- Использует curl-cffi для незаметных HTTP-запросов
- Использует Playwright для автоматизации браузера при необходимости
- Сохраняет и загружает cookies для избежания повторной аутентификации
- Извлекает данные с веб-страниц
- Отправляет спарсенные данные в другие модули для обработки
- Объектно-ориентированный дизайн для легкого расширения

## Требования

- Python 3.7+
- Зависимости, перечисленные в `requirements.txt`

## Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/Jeff555max/AvitoParser.git
   cd AvitoParser
   ```

2. Создайте виртуальное окружение:
   ```
   python -m venv venv
   source venv/bin/activate  # В Windows: venv\Scripts\activate
   ```

3. Установите зависимости:
   ```
   python init_project.py
   pip install -r requirements.txt
   ```


## Быстрый запуск в Docker

1. Убедитесь, что у вас есть файл `.env` с нужными переменными (например, URL и, при необходимости, PROXY_URL).
2. Соберите и запустите контейнер:
   ```
   docker compose up --build
   ```
3. База данных будет храниться вне контейнера (volume db_data).

---

## Использование без Docker

1. Создайте файл .env 
   Создайте в нем целевой URL 
   URL="ваш адрес"
2. Запустите парсер:
   ```
   python main.py
   ```

## Структура проекта

- `src/` - Основной исходный код
  - `base_parser.py` - Базовый класс парсера
  - `anti_bot_parser.py` - Реализация парсера с обходом защиты от ботов

- `services/` - Вспомогательные модули
  - `headers.py` - Управление пользовательскими заголовками
  - `user_agent_pc.txt` - Список user agent'ов
- `cookies.json` - Сохраненные cookies (создается после первого запуска)
- `main.py` - Пример использования
## Как это работает

1. Парсер сначала пытается получить контент, используя curl-cffi с пользовательскими заголовками
2. Если обнаружена защита Cloudflare или другая система защиты от ботов, переключается на Playwright
3. Playwright открывает реальный браузер, переходит на страницу и обходит защиту
4. Cookies сохраняются в `cookies.json` для последующего использования
5. Извлеченные данные отправляются в другие модули для обработки

## Расширение парсера

Чтобы расширить парсер для ваших конкретных нужд:

1. Унаследуйтесь от `AntiBotParser` в `src/anti_bot_parser.py`
2. Переопределите метод `extract_data` для парсинга нужных вам данных
3. Измените метод `send_to_module` для интеграции с вашими модулями обработки


## Telegram-бот для управления парсером

Бот позволяет запускать парсер по кнопке, просматривать последние объекты из базы с пагинацией, а также управлять настройками (заглушка).

### Запуск бота
1. Установите зависимости:
   ```
   pip install pytelegrambotapi
   ```
2. Укажите токен и параметры бота в `.env`:
   ```
   TELEGRAM_BOT_TOKEN="ваш_токен"
   ADMIN_IDS="123456789"
   PAGE_SIZE=5
   ```
3. Запустите бота:
   ```
   python bot/bot_main.py
   ```

### Структура бота
- `bot/bot_main.py` — основной файл бота
- `main.py` — основной парсер (запускается ботом)

---

Возможна блокировка из-за подозрительного IP адреса (пробуйте разные варианты)